name: Update My Mega IPTV
on:
  schedule:
    - cron: '0 */4 * * *' # Обновляем каждые 4 часа, чтобы токены не успели умереть
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
      - name: Fetch and Filter All Categories
        run: |
          # 1. Загружаем несколько разных баз для надежности
          curl -L https://iptv-org.github.io/iptv/index.m3u > global.m3u
          curl -L https://iptv-org.github.io/iptv/countries/ru.m3u > russia.m3u
          
          # 2. Создаем чистый плейлист
          echo "#EXTM3U" > personal_list.m3u
          
          # 3. ФИЛЬТРАЦИЯ ПО ТВОИМ КАТЕГОРИЯМ
          # Мы используем список ключевых слов из твоего запроса
          
          # КИНО, СЕРИАЛЫ И VIJU
          grep -iE "Viju|TV 1000|Action|Premiere|Megahit|Comedy|Serial|FOX|Hollywood|Bollywood|FilmBox|TV XXI|START|НТВ Сериал|Мосфильм|Кинохит|Киномикс|Киносерия|Amedia|Shot TV|KION" global.m3u russia.m3u | grep -v "http" -A 1 | grep -v "\--" >> personal_list.m3u
          
          # ИНФОРМАЦИОННЫЕ И ФЕДЕРАЛЬНЫЕ
          grep -iE "Первый канал|Россия 1|Россия 24|Planeta RTR|МИР|НТВ|ТВ Центр|RTVI|OTP|Доверие|5 Канал|РБК|Спас|EuroNews|CNN|ABC|BBC|France 24" russia.m3u global.m3u | grep -v "http" -A 1 | grep -v "\--" >> personal_list.m3u
          
          # СПОРТ (Матч, Футбол, Eurosport)
          grep -iE "Матч|Футбол|Setanta|UDAR|MMA|Бокс|Хоккей|KHL|NBA|Eurosport|Sky Sports|Viasat Sport" global.m3u russia.m3u | grep -v "http" -A 1 | grep -v "\--" >> personal_list.m3u
          
          # ДЕТСКИЕ И РАЗВЛЕКАТЕЛЬНЫЕ
          grep -iE "Cartoon|Nickelodeon|Nick|Disney|Мульт|Карусель|TiJi|2x2|Солнце|СТС|ТНТ|Пятница|Ю|ТВ 3|ЧЕ" global.m3u russia.m3u | grep -v "http" -A 1 | grep -v "\--" >> personal_list.m3u
          
          # ПОЗНАВАТЕЛЬНЫЕ
          grep -iE "Animal Planet|Discovery|National Geographic|Wild|Моя Планета|Наука|История|History|Travel|Explore|Охота|Рыбалка|TLC" global.m3u russia.m3u | grep -v "http" -A 1 | grep -v "\--" >> personal_list.m3u
          
          # 4K, UHD, CINEMAN, MINIMAX
          grep -iE "4K|UHD|Ultra|CineMan|MiniMax|GoldLine|NASA|Museum" global.m3u russia.m3u | grep -v "http" -A 1 | grep -v "\--" >> personal_list.m3u

      - name: Save Playlist
        run: |
          git config --local user.email "actions@github.com"
          git config --local user.name "AutoUpdater"
          git add personal_list.m3u
          git commit -m "Updated all channels from the big list" || exit 0
          git push
