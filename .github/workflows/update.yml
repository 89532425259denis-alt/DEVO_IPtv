name: Update My Mega IPTV
on:
  schedule:
    - cron: '0 */4 * * *' # Запуск каждые 4 часа
  workflow_dispatch:      # Кнопка ручного запуска

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Fetch and Filter
        run: |
          # 1. ЗАГРУЗКА ИСТОЧНИКОВ
          # Используем максимальный набор источников для поиска редких каналов
          curl -sL https://iptv-org.github.io/iptv/index.m3u > global.m3u
          curl -sL https://iptv-org.github.io/iptv/countries/ru.m3u > russia.m3u
          curl -sL https://iptv-org.github.io/iptv/categories/movies.m3u > movies.m3u
          curl -sL https://iptv-org.github.io/iptv/categories/animation.m3u > animation.m3u
          curl -sL https://iptv-org.github.io/iptv/categories/sports.m3u > sports.m3u
          curl -sL https://iptv-org.github.io/iptv/categories/documentary.m3u > documentary.m3u
          curl -sL https://iptv-org.github.io/iptv/categories/education.m3u > education.m3u
          curl -sL https://iptv-org.github.io/iptv/categories/entertainment.m3u > entertainment.m3u

          # Объединяем базы в один файл для чистого поиска
          cat global.m3u russia.m3u movies.m3u animation.m3u sports.m3u documentary.m3u education.m3u entertainment.m3u > source.tmp

          # Создаем итоговый файл
          echo "#EXTM3U" > personal_list.m3u

          # --- ФУНКЦИЯ ПОИСКА ---
          find_channels() {
            # Ищет совпадения, берет следующую строку (ссылку), удаляет разделители групп
            grep -i -E "$1" source.tmp -A 1 --no-group-separator | grep -vE "^--$" >> personal_list.m3u
          }

          # --- БЛОК 1: ИНФОРМАЦИОННЫЕ ---
          # Федеральные, Новости, Международные
          echo "Processing News..."
          find_channels "Первый канал|Россия 1|Россия 24|Planeta RTR|МИР|НТВ|ТВ ЦЕНТР|ТВ Центр|RTVI|OTP|ОТР|Москва Доверие|Центральное телевидение|5 Канал|Пятый канал|Крым 24|РБК|Спас|EuroNews|CNN|Fox News|ABC|BBC|France 24|CNBC|Настоящее время|Дождь|RTД|RTVi"

          # --- БЛОК 2: КИНО И СЕРИАЛЫ ---
          # Viju, Amedia, Start, KION, Dizi, CineMan, GoldLine, Русское и Зарубежное
          echo "Processing Movies..."
          find_channels "Viju|TV1000|TV 1000|Premiere|Megahit|Comedy|Serial|FOX|Hollywood|Bollywood|FilmBox|TV XXI|FlixSnip|Мосфильм|Золотая коллекция|Детектив|Русский роман|Наше Новое Кино|Родное кино|Дом Кино|Кино ТВ|Феникс|Мир сериала|Русский Иллюзион|Русский бестселлер|START|Кинохит|Киномикс|Киносвидание|Кинокомедия|Киносерия|Киносемья|Кинопремьера|Киноужас|Кинопоказ|Индийское кино|Мужское кино|Настоящее страшное|Еврокино|Иллюзион|sci-fi|black|red|Любимое|Лавстори|Про Любовь|Романтичное|Страшное|Премиальное|Душевное|Шокирующее|Остросюжетное|Комедийное|Сапфир|Dizi|Zee TV|Amedia|Shot|FAN|Star|О! Кино|Комедия|Кинеко|KION|Kinoliving|Scream|Дорама|Блокбастер|Хит|CineMan|MiniMax|GoldLine|Marvel|Триллер|Сваты|VHS|Боевик|Ужасы|Роскино|Киберпанк"

          # --- БЛОК 3: ПОЗНАВАТЕЛЬНЫЕ ---
          # Discovery, Eda, Auto, History, Travel
          echo "Processing Education..."
          find_channels "Animal Planet|Discovery|National Geographic|Nat Geo|Моя Планета|Nature|В мире животных|Наука|Галактики|Космический|История|History|Travel|Explore|RTG|365 Дней|Телепутешествия|Приключения|ЕДА|Кухня|Food|Телекафе|Охота|Рыбалка|Трофей|Авто|Техно|TLC|Доктор|Здоровое|Психология|Усадьба|English Club|Fashion"

          # --- БЛОК 4: СПОРТИВНЫЕ ---
          # Матч, Футбол, KHL, Setanta, Eurosport
          echo "Processing Sports..."
          find_channels "Матч|Футбол|Setanta|UDAR|MMA|Бокс|Хоккей|KHL|КХЛ|NBA|Eurosport|Sky Sports|Extreme|ESPN|Viasat Sport|Конный"

          # --- БЛОК 5: РАЗВЛЕКАТЕЛЬНЫЕ ---
          # СТС, ТНТ, Пятница, Ю, Ретро
          echo "Processing Entertainment..."
          find_channels "СТС|ТНТ|РЕН|Пятница|Суббота|Ю|ТВ 3|ТВ3|ЧЕ|КВН|Ностальгия|Ретро|Домашний|Перец|Квартал|Сарафан|Лапки|Театр|Капитан Фантастика"

          # --- БЛОК 6: ДЕТСКИЕ ---
          # Disney, Cartoon, Nick, Карусель
          echo "Processing Kids..."
          find_channels "Мультимузыка|Cartoon|Nickelodeon|Nick|TiJi|2x2|Солнце|Мульт|КиноМульт|Мультиландия|Карусель|Уникум|Gulli|Лёва|В гостях у сказки|Мама|CTC Kids|Рыжий|Ani"

          # --- БЛОК 7: 4K / UHD ---
          # Специальный поиск для высокого разрешения
          echo "Processing 4K/UHD..."
          find_channels "4K|UHD|Ultra"

          # Удаляем временные файлы
          rm *.tmp global.m3u russia.m3u movies.m3u animation.m3u sports.m3u documentary.m3u education.m3u entertainment.m3u

      - name: Save
        run: |
          git config --local user.email "actions@github.com"
          git config --local user.name "AutoUpdater"
          git add personal_list.m3u
          git commit -m "Updated Mega Playlist: Custom Channel List" || echo "No changes to commit"
          git push
