name: Update My Mega IPTV
on:
  schedule:
    - cron: '0 */4 * * *'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
      - name: Fetch and Filter
        run: |
          # 1. Загружаем расширенные базы (включая тематические)
          curl -L https://iptv-org.github.io/iptv/index.m3u > global.m3u
          curl -L https://iptv-org.github.io/iptv/countries/ru.m3u > russia.m3u
          # Добавляем базу категорий "Кино" и "Анимация" - там чаще всего лежат TV1000 и Minimax
          curl -L https://iptv-org.github.io/iptv/categories/movies.m3u > movies.m3u
          curl -L https://iptv-org.github.io/iptv/categories/animation.m3u > animation.m3u
          
          echo "#EXTM3U" > personal_list.m3u
          
          # 2. Поиск КИНО (Добавлен Viju и более точный поиск TV1000/CineMan)
          # Важно: TV1000 теперь называется Viju, поэтому ищем оба варианта
          grep -iE "Viju|TV1000|TV 1000|Action|CineMan|Cineman|GoldLine|Amedia|Кинохит|Мосфильм|START|KION" global.m3u russia.m3u movies.m3u | grep -v "http" -A 1 | grep -v "\--" >> personal_list.m3u
          
          # 3. Поиск ДЕТСКИХ (Minimax, Nickelodeon, Disney)
          grep -iE "Minimax|MiniMax|Nickelodeon|Disney|Cartoon|Мульт|Карусель|TiJi|Gulli" global.m3u russia.m3u animation.m3u | grep -v "http" -A 1 | grep -v "\--" >> personal_list.m3u
          
          # 4. Поиск ОСТАЛЬНОГО (Федеральные, Матч, 4K)
          grep -iE "Первый канал|Россия 1|НТВ|Матч|Футбол|4K|UHD|Ultra" russia.m3u global.m3u | grep -v "http" -A 1 | grep -v "\--" >> personal_list.m3u

      - name: Save
        run: |
          git config --local user.email "actions@github.com"
          git config --local user.name "AutoUpdater"
          git add personal_list.m3u
          git commit -m "Fixed TV1000, Minimax and CineMan" || exit 0
          git push
