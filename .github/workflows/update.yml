name: Update My Mega IPTV
on:
  schedule:
    - cron: '0 */4 * * *'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
      
      - name: Fetch and Filter
        run: |
          # 1. ЗАГРУЗКА БАЗ (Расширенный список источников)
          # Качаем глобальную, Россию, а также специализированные категории для максимального охвата
          curl -L https://iptv-org.github.io/iptv/index.m3u > global.m3u
          curl -L https://iptv-org.github.io/iptv/countries/ru.m3u > russia.m3u
          curl -L https://iptv-org.github.io/iptv/categories/movies.m3u > movies.m3u
          curl -L https://iptv-org.github.io/iptv/categories/animation.m3u > animation.m3u
          curl -L https://iptv-org.github.io/iptv/categories/sports.m3u > sports.m3u
          curl -L https://iptv-org.github.io/iptv/categories/documentary.m3u > documentary.m3u
          curl -L https://iptv-org.github.io/iptv/categories/education.m3u > education.m3u
          curl -L https://iptv-org.github.io/iptv/categories/entertainment.m3u > entertainment.m3u

          # Создаем итоговый файл
          echo "#EXTM3U" > personal_list.m3u
          
          # --- БЛОК 1: ФЕДЕРАЛЬНЫЕ И НОВОСТНЫЕ ---
          # Первый, Россия, НТВ, РЕН, СТС, ТНТ, Звезда, ТВЦ, МИР, Дождь, Euronews, CNN и др.
          echo "Processing Federal/News..."
          grep -iE "Первый канал|Россия 1|Россия 24|Planeta RTR|НТВ|ТВ ЦЕНТР|ТВ Центр|RTVI|OTP|ОТР|Москва Доверие|Центральное|5 Канал|Пятый канал|Крым 24|РБК|Спас|Звезда|EuroNews|CNN|Fox News|ABC|BBC|France 24|CNBC|Настоящее время|Дождь|RTД|RTVi" global.m3u russia.m3u | grep -v "http" -A 1 | grep -v "\--" >> personal_list.m3u

          # --- БЛОК 2: КИНО И СЕРИАЛЫ (MEGA PACK) ---
          # Viju, TV1000, Amedia, Fox, Русское кино, CineMan, GoldLine, Start, KION, Dizi
          echo "Processing Movies..."
          grep -iE "Viju|TV1000|TV 1000|Action|Premiere|Megahit|Comedy|Serial|Сериал|FOX|Hollywood|Bollywood|FilmBox|TV XXI|FlixSnip|Мосфильм|Золотая коллекция|Детектив|Роман|Родное|Дом Кино|Феникс|Иллюзион|START|KION|Кинохит|Киномикс|Киносвидание|Кинокомедия|Киносерия|Киносемья|Кинопремьера|Киноужас|Кинопоказ|Индийское|Еврокино|Sci-Fi|Black|Red|Love|Лавстори|Про Любовь|Сапфир|Dizi|Zee|Amedia|Shot|FAN|Star|О! Кино|Кинеко|Kinoliving|Scream|Дорама|Блокбастер|Хит|CineMan|Cineman|GoldLine|Marvel|Сваты|VHS|Киберпанк" global.m3u russia.m3u movies.m3u entertainment.m3u | grep -v "http" -A 1 | grep -v "\--" >> personal_list.m3u

          # --- БЛОК 3: ДЕТСКИЕ ---
          # Disney, Nick, Cartoon, Minimax, Мульт, Карусель
          echo "Processing Kids..."
          grep -iE "Minimax|MiniMax|Nickelodeon|Disney|Cartoon|Мульт|Карусель|TiJi|Gulli|2x2|Солнце|Уникум|Лёва|Сказки|Мама|CTC Kids|Рыжий|Ani|Ани|Детский" global.m3u russia.m3u animation.m3u | grep -v "http" -A 1 | grep -v "\--" >> personal_list.m3u

          # --- БЛОК 4: ПОЗНАВАТЕЛЬНЫЕ ---
          # Discovery, Nat Geo, Animal Planet, History, Еда, Охота, Авто
          echo "Processing Education..."
          grep -iE "Animal Planet|Discovery|National Geographic|Nat Geo|Моя Планета|Nature|В мире животных|Наука|Галактики|Космический|История|History|Travel|Explore|RTG|365 Дней|Приключения|Еда|Кухня|Food|Телекафе|Охота|Рыбалка|Трофей|Авто|Плюс|Техно|TLC|Доктор|Здоровое|Психология|Усадьба|English Club|Fashion" global.m3u russia.m3u documentary.m3u education.m3u | grep -v "http" -A 1 | grep -v "\--" >> personal_list.m3u

          # --- БЛОК 5: СПОРТ ---
          # Матч, Футбол, KHL, Setanta, Eurosport, NBA, UFC, MMA
          echo "Processing Sports..."
          grep -iE "Матч|Match|Футбол|Football|Setanta|UDAR|MMA|Бокс|Boxing|Хоккей|Hockey|KHL|КХЛ|NBA|Eurosport|Sky Sports|Extreme|ESPN|Viasat Sport|Конный" global.m3u russia.m3u sports.m3u | grep -v "http" -A 1 | grep -v "\--" >> personal_list.m3u

          # --- БЛОК 6: РАЗВЛЕКАТЕЛЬНЫЕ ---
          # СТС, ТНТ, Пятница, Ю, ТВ3, Перец, КВН
          echo "Processing Entertainment..."
          grep -iE "СТС|ТНТ|РЕН ТВ|Пятница|Суббота|Ю|ТВ 3|ТВ3|ЧЕ|КВН|Ностальгия|Ретро|Домашний|Перец|Квартал|Сарафан|Лапки|Театр" global.m3u russia.m3u entertainment.m3u | grep -v "http" -A 1 | grep -v "\--" >> personal_list.m3u

          # --- БЛОК 7: 4K / UHD ---
          # Отдельный поиск каналов высокого качества
          echo "Processing 4K/UHD..."
          grep -iE "4K|UHD|Ultra" global.m3u russia.m3u | grep -v "http" -A 1 | grep -v "\--" >> personal_list.m3u

      - name: Save
        run: |
          git config --local user.email "actions@github.com"
          git config --local user.name "AutoUpdater"
          git add personal_list.m3u
          git commit -m "Updated Mega Playlist with Full Channel List" || exit 0
          git push
